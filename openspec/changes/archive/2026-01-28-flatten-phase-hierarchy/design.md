# Design: flatten-phase-hierarchy

## 아키텍처 결정

### 1. Phase 동등성 모델

#### 현재 모델 (계층적)
```
Phase 1 (60%) ──→ Phase 2 (70%) ──→ Phase 3 (90%) ──→ 완료
     ↓                 ↓                 ↓
   반복              반복              반복
```

#### 새 모델 (동등)
```
          ┌─────────────────┐
          │   사전 검사     │
          └────────┬────────┘
                   ↓
          ┌─────────────────┐
          │  HITL Phase     │ ←──────────────────┐
          │     선택        │                    │
          └────────┬────────┘                    │
         ┌────────┼────────┐                     │
         ↓        ↓        ↓                     │
    ┌────────┐┌────────┐┌────────┐              │
    │Phase 1 ││Phase 2 ││Phase 3 │              │
    │ Figma  ││ LLM    ││ LLM    │              │
    │ 재추출 ││이미지  ││ DOM    │              │
    └───┬────┘└───┬────┘└───┬────┘              │
        │         │         │                    │
        ↓         ↓         ↓                    │
    ┌────────┐┌────────┐┌────────┐              │
    │Pixel   ││Pixel   ││DOM비교 │              │
    │비교    ││비교    ││   +    │              │
    │        ││        ││Pixel   │              │
    └───┬────┘└───┬────┘└───┬────┘              │
        │         │         │                    │
        └─────────┴─────────┴────────────────────┘
                         ↓
                    [완료 선택 시]
                         ↓
                      종료
```

### 2. HITL 옵션 설계

#### 통합 HITL 메시지
```
✋ HITL - 다음 작업을 선택하세요

[1] Phase 1: Figma MCP 재추출
    └─ 디자인에서 코드를 다시 추출합니다

[2] Phase 2: LLM 이미지 diff 수정
    └─ 픽셀 차이를 분석하여 LLM이 코드를 수정합니다

[3] Phase 3: LLM DOM 수정
    └─ DOM 구조 차이를 분석하여 LLM이 코드를 수정합니다

[완료] 현재 상태로 종료
    └─ 현재 성공률로 작업을 마칩니다
```

#### 옵션 키 일관성
- `[1]`, `[2]`, `[3]`: Phase 번호와 일치
- `[완료]` 또는 `[Y]`: 종료
- `[S]` 또는 `[취소]`: 워크플로우 중단

### 3. 성공률 표시 설계

#### Phase 1, 2 (단일 성공률)
```
📊 결과

| 항목 | 값 |
|------|-----|
| 픽셀 성공률 | ████████░░ 82.3% |

📌 참고 기준
- Phase 1: 60% (Figma 재추출로 달성 가능한 일반적 수준)
- Phase 2: 70% (LLM 이미지 수정으로 달성 가능한 일반적 수준)
- Phase 3: 90% (LLM DOM 수정으로 달성 가능한 일반적 수준)
```

#### Phase 3 (이중 성공률)
```
📊 결과

| 항목 | 값 |
|------|-----|
| DOM 성공률 | ███████░░░ 75.0% |
| 픽셀 성공률 | ████████░░ 85.2% |

📌 참고 기준
- Phase 1: 60% (Figma 재추출로 달성 가능한 일반적 수준)
- Phase 2: 70% (LLM 이미지 수정으로 달성 가능한 일반적 수준)
- Phase 3: 90% (LLM DOM 수정으로 달성 가능한 일반적 수준)
```

### 4. 상태 관리

#### 무상태(Stateless) 유지
- 각 Phase 도구는 독립적으로 실행
- 이전 Phase 결과에 의존하지 않음
- 반복 횟수(`iteration`)는 Phase별 카운트 유지

#### 세션 정보 (선택적)
- AI 에이전트가 대화 컨텍스트에서 관리
- MCP 서버는 상태를 저장하지 않음

### 5. 하위 호환성

#### 유지되는 파라미터
- `successRate`: 현재 성공률 입력
- `iteration`: 현재 Phase 반복 횟수
- `targetRate`: 참고 기준으로만 사용 (동작 변경)
- `maxIterations`: 반복 제한 (유지)
- `previousRates`: 이력 추적 (유지)

#### 동작 변경
- `targetRate` 도달 여부로 "권장" 표시하지 않음
- 모든 경우에 동일한 HITL 옵션 표시

## 트레이드오프

### 선택: 동등한 Phase 선택 (채택)

**장점**:
- 사용자가 상황에 맞는 Phase 직접 선택
- 유연한 워크플로우
- 시스템 판단 오류 제거

**단점**:
- 초보 사용자에게 가이드 부족
- Phase 선택에 대한 이해 필요

**대안 (미채택)**: 자동 Phase 추천 유지
- 시스템이 성공률 기반으로 추천
- 사용자가 오버라이드 가능
- 복잡도 증가로 미채택

### 선택: 참고 기준만 표시 (채택)

**장점**:
- 사용자 판단 존중
- 다양한 프로젝트 요구사항 수용

**단점**:
- 명확한 "완료" 기준 없음

**대안 (미채택)**: 목표 성공률 필수
- 시스템이 완료 여부 판단
- 유연성 부족으로 미채택
